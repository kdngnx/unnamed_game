#define SDL_MAIN_USE_CALLBACKS 1
#include <SDL3/SDL.h>
#include <SDL3/SDL_main.h>

#include <cstdint>
#include <string>
#include <vector>

constexpr uint32_t kGameWidth = 40;
constexpr uint32_t kGameHeight = 30;
constexpr uint32_t kBlockSizeInPixels = 20;
constexpr uint32_t kWindowWidth = (kGameWidth * kBlockSizeInPixels);
constexpr uint32_t kWindowHeight = (kGameHeight * kBlockSizeInPixels);

struct BulletContext {
    float xpos;
    float ypos;
    uint64_t last_step;
};

struct AircraftContext {
    float xpos;
    float ypos;
    std::vector<BulletContext> bullets;
    uint32_t bullet_length = kBlockSizeInPixels / 2;
    uint32_t bullet_velocity_ms = 20;
};

struct AppState {
    SDL_Window *window;
    SDL_Renderer *renderer;
    AircraftContext aircraft_ctx;
};

SDL_AppResult LogErrAndFail(const std::string msg) {
    const std::string msg_with_err = msg + "\n%s";
    SDL_LogError(SDL_LOG_CATEGORY_ERROR, msg_with_err.c_str(), SDL_GetError());
    return SDL_APP_FAILURE;
}

void AddBullet(AircraftContext *ctx) {
    BulletContext bullet = {ctx->xpos + ctx->bullet_length,
                            ctx->ypos - ctx->bullet_length, SDL_GetTicks()};
    ctx->bullets.push_back(bullet);
}

// run once at startup
SDL_AppResult SDL_AppInit(void **appstate, int argc, char *argv[]) {
    if (!SDL_SetAppMetadata("unnamed_game", "1.0", "org.libsdl.unnamed_game")) {
        return LogErrAndFail("Failed to set app metadata");
    }
    if (!SDL_Init(SDL_INIT_VIDEO | SDL_INIT_JOYSTICK)) {
        return LogErrAndFail("Couldn't init SDL");
    }
    AppState *app = new AppState();
    if (!app) {
        return LogErrAndFail("Couldn't allocate resources for app state");
    }
    *appstate = app;
    app->aircraft_ctx.xpos = (kWindowWidth / 2.0f) - kBlockSizeInPixels;
    app->aircraft_ctx.ypos = kWindowHeight - 2 * kBlockSizeInPixels;
    if (!SDL_CreateWindowAndRenderer("unnamed_game", kWindowWidth,
                                     kWindowHeight, SDL_WINDOW_RESIZABLE,
                                     &app->window, &app->renderer)) {
        return LogErrAndFail("Failed to create window/renderer");
    }
    SDL_SetRenderLogicalPresentation(app->renderer, kWindowWidth, kWindowHeight,
                                     SDL_LOGICAL_PRESENTATION_LETTERBOX);
    return SDL_APP_CONTINUE;
}

static SDL_AppResult HandleKeyDownEvent(AircraftContext *ctx,
                                        const SDL_Scancode key_code) {
    const float xpos = ctx->xpos;
    const float ypos = ctx->ypos;
    switch (key_code) {
        case SDL_SCANCODE_ESCAPE:
        case SDL_SCANCODE_Q:
            return SDL_APP_SUCCESS;
        case SDL_SCANCODE_LEFT: {
            const float new_pos = ctx->xpos - kBlockSizeInPixels;
            ctx->xpos = (new_pos < 0) ? 0 : new_pos;
            break;
        }
        case SDL_SCANCODE_RIGHT: {
            const float new_pos = ctx->xpos + kBlockSizeInPixels;
            const float barrier = kWindowWidth - kBlockSizeInPixels;
            ctx->xpos = (new_pos > barrier) ? barrier : new_pos;
            break;
        }
        case SDL_SCANCODE_UP: {
            const float new_pos = ctx->ypos - kBlockSizeInPixels;
            ctx->ypos = (new_pos < 0) ? 0 : new_pos;
            break;
        }
        case SDL_SCANCODE_DOWN: {
            const float new_pos = ctx->ypos + kBlockSizeInPixels;
            const float barrier = kWindowHeight - kBlockSizeInPixels;
            ctx->ypos = (new_pos > barrier) ? barrier : new_pos;
            break;
        }
        case SDL_SCANCODE_SPACE:
            AddBullet(ctx);
            break;
        default:
            break;
    }
    return SDL_APP_CONTINUE;
}

SDL_AppResult SDL_AppEvent(void *appstate, SDL_Event *event) {
    AircraftContext *ctx = &((AppState *)appstate)->aircraft_ctx;
    switch (event->type) {
        case SDL_EVENT_QUIT:
            return SDL_APP_SUCCESS;
        case SDL_EVENT_KEY_DOWN:
            return HandleKeyDownEvent(ctx, event->key.scancode);
        default:
            break;
    }
    return SDL_APP_CONTINUE;
}

SDL_FRect GetAircraftSprite(const AppState *app) {
    SDL_FRect rect;
    SDL_SetRenderDrawColor(app->renderer, 7, 54, 66, SDL_ALPHA_OPAQUE);
    rect.x = app->aircraft_ctx.xpos;
    rect.y = app->aircraft_ctx.ypos;
    rect.w = rect.h = kBlockSizeInPixels;
    return rect;
}

// run once per frame
SDL_AppResult SDL_AppIterate(void *appstate) {
    AppState *app = (AppState *)appstate;
    const uint64_t now = SDL_GetTicks();

    SDL_SetRenderDrawColor(app->renderer, 32, 32, 32, SDL_ALPHA_OPAQUE);
    SDL_RenderClear(app->renderer);

    SDL_FRect aircraft_sprite = GetAircraftSprite(app);
    SDL_RenderFillRect(app->renderer, &aircraft_sprite);

    SDL_SetRenderDrawColor(app->renderer, 123, 231, 32, SDL_ALPHA_OPAQUE);
    std::vector<int> removed_bullets;
    for (int i = 0; i < app->aircraft_ctx.bullets.size(); i++) {
        if (app->aircraft_ctx.bullets[i].ypos < 0) {
            removed_bullets.push_back(i);
            continue;
        }
        while ((now - app->aircraft_ctx.bullets[i].last_step) >=
               app->aircraft_ctx.bullet_velocity_ms) {
            app->aircraft_ctx.bullets[i].ypos--;
            app->aircraft_ctx.bullets[i].last_step +=
                app->aircraft_ctx.bullet_velocity_ms;
        }
        SDL_RenderLine(
            app->renderer, app->aircraft_ctx.bullets[i].xpos,
            app->aircraft_ctx.bullets[i].ypos - (kBlockSizeInPixels / 2.0f),
            app->aircraft_ctx.bullets[i].xpos,
            app->aircraft_ctx.bullets[i].ypos);
    }

    for (int index : removed_bullets) {
        app->aircraft_ctx.bullets.erase(app->aircraft_ctx.bullets.begin() +
                                        index);
    }

    SDL_RenderPresent(app->renderer);
    return SDL_APP_CONTINUE;
}

void SDL_AppQuit(void *appstate, SDL_AppResult result) {
    if (appstate != NULL) {
        AppState *app = (AppState *)appstate;
        SDL_DestroyRenderer(app->renderer);
        SDL_DestroyWindow(app->window);
        app->aircraft_ctx.bullets.clear();
        delete app;
    }
    SDL_Log("app quit successfully");
    SDL_Quit();
}
